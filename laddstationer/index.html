<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Laddstationformulär – Mockup-formulär för öppna data om laddstationer</title>

    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css" integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous">

    <link rel="stylesheet" type="text/css" href="style.css">

  </head>

  <body>

    <header class="border-bottom">
      <div class="container">
        <div class="row">
          <div class="col-md-12 py-3">
            <h1>Laddstationformulär</h1>
            <div>Mockup-formulär för öppna data om laddstationer</div>
          </div>
        </div>
      </div>
    </header>

    <div class="container page">

      <div class="row">

        <div class="col-12 col-lg-6 form-container">

          <fieldset class="border rounded-lg">
            <legend>Basinfo</legend>

            <div class="form-group row">
              <label for="input-station-name" class="col-md-4 col-form-label">Laddstationsnamn</label>
              <div class="col-md-8">
                <input type="text" name="name" class="form-control" id="input-station-name" placeholder="T. ex. “Stationen på Elgatan”">
              </div>
            </div>

            <div class="form-group row">
              <label for="input-owner" class="col-md-4 col-form-label">Ägare</label>
              <div class="col-md-8">
                <input type="text" name="owner" class="form-control" id="input-owner" placeholder="T. ex. “Elentusiasterna AB”">
              </div>
            </div>

            <div class="form-group row">
              <label for="input-email" class="col-md-4 col-form-label">Kontakt, e-mail</label>
              <div class="col-md-8">
                <input type="text" name="email" class="form-control" id="input-email" placeholder="T. ex. “info@elentusiasterna.se”">
              </div>
            </div>

            <div class="form-group row">
              <label class="col-md-4 col-form-label">Status</label>
              <div class="col-md-8">
                <select name="status" class="custom-select">
                  <option value="">Välj…</option>
                  <option value="working">Fungerande</option>
                  <option value="withIncidence">Med uppehåll</option>
                  <option value="outOfService">Ur funktion</option>
                  <option value="full">Full</option>
                  <option value="almostFull">Nästan full</option>
                  <option value="almostEmpty">Nästan tom</option>
                  <option value="empty">Tom</option>
                </select>
              </div>
            </div>

            <div class="form-group row">
              <label for="input-created" class="col-md-4 col-form-label">Skapad, datum</label>
              <div class="col-md-8">
                <input type="text" name="created" class="form-control" id="input-created" placeholder="ÅÅÅÅ-MM-DD">
              </div>
            </div>

            <div class="form-group row">
              <label for="input-modified" class="col-md-4 col-form-label">Ändrad, datum</label>
              <div class="col-md-8">
                <input type="text" name="modified" class="form-control" id="input-modified" placeholder="ÅÅÅÅ-MM-DD">
                <span class="form-text text-muted">(Lämna tomt om data inte uppdaterats)</span>
              </div>
            </div>

          </fieldset>


          <fieldset class="border rounded-lg pt-0">
            <legend>Laddpunkter</legend>

            <div class="form-group row border-bottom">
              <label class="col-3 col-form-label pr-0">Typ</label>
              <label class="col-3 col-form-label pr-0 pl-1">Effekt, kW</label>
              <label class="col-6 col-form-label pl-1">Standard</label>
            </div>

            <div class="connectors" data-list-key="connectors" data-list-item-selector=".connector">

              <div class="form-group row connector">
                <div class="col-3 pr-0">
                  <select name="level" class="custom-select">
                    <option value="">Välj…</option>
                    <option value="1">Typ 1</option>
                    <option value="2">Typ 2</option>
                    <option value="3">Typ 3</option>
                  </select>
                </div>
                <div class="col-3 pr-0 pl-1">
                  <input type="number" name="kiloWatt" class="form-control" placeholder="T. ex. “22”">
                </div>
                <div class="col-6 pl-1">
                  <select name="standard" class="custom-select">
                    <option value="">Välj…</option>
                    <option>CHAdeMO</option>
                    <option>CCS</option>
                    <option>Annan</option>
                  </select>
                </div>
              </div>

            </div>

            <button type="button" class="btn btn-info btn-sm btn-add-row">+ Lägg till rad</button>

          </fieldset>


          <fieldset class="border rounded-lg" data-key="location">
            <legend>Plats</legend>

            <div class="form-group row">
              <label for="input-address" class="col-md-4 col-form-label">Adress &amp; postnr.</label>
              <div class="col-8 col-md-5 pr-0">
                <input type="text" name="address" class="form-control" id="input-address" placeholder="T. ex. “Elgatan 12 B”">
              </div>
              <div class="col-4 col-md-3">
                <input type="text" name="postalCode" class="form-control" id="input-postal-address" placeholder="NNN NN">
              </div>
            </div>

            <div class="form-group row">
              <label for="select-location-type" class="col-md-4 col-form-label">Typ</label>
              <div class="col-md-8">
                <select name="type" id="select-location-type" class="custom-select">
                  <option value="">Välj…</option>
                  <option>Gatuplan</option>
                  <option>Parkeringshus</option>
                  <option>Flygplats</option>
                  <option>Köpcenter</option>
                  <option>Hotell</option>
                  <option>Restaurang</option>
                  <option>Bensinstation</option>
                </select>
              </div>
            </div>

            <div class="form-group row">
              <label for="select-availability" class="col-md-4 col-form-label">Tillgänglighet</label>
              <div class="col-md-8">
                <select name="type" id="select-availability" class="custom-select">
                  <option value="">Välj…</option>
                  <option>Publik</option>
                  <option>Endast besökare</option>
                  <option>Privat</option>
                </select>
              </div>
            </div>

            <div class="form-group row">
              <label for="textarea-location-description" class="col-md-4 col-form-label">Beskrivning</label>
              <div class="col-md-8">
                <textarea name="description" class="form-control" id="textarea-location-description" rows="2" placeholder="T. ex. “I parkeringshuset under köpcentret”"></textarea>
              </div>
            </div>

            <div data-key="gps">
              <label class="mt-2">GPS, decimalgrader <span class="text-muted">(WGS84)</span></label>
              <div class="form-group row mb-1">
                <label for="input-gps-latitud" class="col-md-4 col-form-label">Latitud</label>
                <div class="col-md-8">
                  <input type="number" name="latitude" class="form-control" id="input-gps-latitud" placeholder="NN.NNNN…">
                </div>
              </div>
              <div class="form-group row">
                <label for="input-gps-longitud" class="col-md-4 col-form-label">Longitud</label>
                <div class="col-md-8">
                  <input type="number" name="longitude" class="form-control" id="input-gps-longitud" placeholder="NN.NNNN…">
                </div>
              </div>
            </div>

          </fieldset>

          <fieldset class="border rounded-lg">
            <legend>Tider &amp; avgifter</legend>

            <div class="form-group row" data-key="hoursOpen">
              <label class="col-md-4 col-form-label">Öppettider</label>
              <div class="col-md-8 row pr-0">
                <div class="col-6 pr-1">
                  <select name="from" class="custom-select">
                    <option value="">Från…</option>
                    <option value="0">00</option>
                    <option value="1">01</option>
                    <option value="2">02</option>
                    <option value="3">03</option>
                    <option value="4">04</option>
                    <option value="5">05</option>
                    <option value="6">06</option>
                    <option value="7">07</option>
                    <option value="8">08</option>
                    <option value="9">09</option>
                    <option value="10">10</option>
                    <option value="11">11</option>
                    <option value="12">12</option>
                    <option value="13">13</option>
                    <option value="14">14</option>
                    <option value="15">15</option>
                    <option value="16">16</option>
                    <option value="17">17</option>
                    <option value="18">18</option>
                    <option value="19">19</option>
                    <option value="20">20</option>
                    <option value="21">21</option>
                    <option value="22">22</option>
                    <option value="23">23</option>
                    <option value="24">24</option>
                  </select>
                </div>
                <div class="col-6 pl-1 pr-0">
                  <select name="to" class="custom-select">
                    <option value="">Till…</option>
                    <option value="0">00</option>
                    <option value="1">01</option>
                    <option value="2">02</option>
                    <option value="3">03</option>
                    <option value="4">04</option>
                    <option value="5">05</option>
                    <option value="6">06</option>
                    <option value="7">07</option>
                    <option value="8">08</option>
                    <option value="9">09</option>
                    <option value="10">10</option>
                    <option value="11">11</option>
                    <option value="12">12</option>
                    <option value="13">13</option>
                    <option value="14">14</option>
                    <option value="15">15</option>
                    <option value="16">16</option>
                    <option value="17">17</option>
                    <option value="18">18</option>
                    <option value="19">19</option>
                    <option value="20">20</option>
                    <option value="21">21</option>
                    <option value="22">22</option>
                    <option value="23">23</option>
                    <option value="24">24</option>
                  </select>
                </div>
                <div class="col-12 pt-2 pr-0">
                  <input type="text" name="description" class="form-control" placeholder="T. ex. “Helgfria vardagar”">
                </div>
              </div>
            </div>

            <div class="form-group row">
              <label class="col-md-4 col-form-label">Tidsbegränsning</label>
              <div class="col-md-2 pr-0">
                <select name="hasTimeLimit" class="custom-select">
                  <option value="">Välj…</option>
                  <option value="true">Ja</option>
                  <option value="false">Nej</option>
                </select>
              </div>
              <div class="col-md-6 pl-1">
                <input type="text" name="timeLimitDescription" class="form-control" placeholder="T. ex. “max 3 tim”">
              </div>
            </div>

            <div data-key="payment">

              <div class="form-group row">
                <label class="col-md-4 col-form-label">Laddningsavgift</label>
                <div class="col-md-2 pr-0">
                  <select name="hasChargingFee" class="custom-select">
                    <option value="">Välj…</option>
                    <option value="true">Ja</option>
                    <option value="false">Nej</option>
                  </select>
                </div>
                <div class="col-md-6 pl-1">
                  <input type="text" name="chargingFeeDescription" class="form-control" placeholder="T. ex. “2kr/kWh”">
                </div>
              </div>

              <div class="form-group row">
                <label class="col-md-4 col-form-label">Betalningsmetoder</label>
                <div class="col-md-8 pt-1 checkboxes" data-list-key="methods">
                  <div class="form-check">
                    <input class="form-check-input" type="checkbox" name="paymentCash" value="Kontant" id="check-payment-cash">
                    <label class="form-check-label" for="check-payment-cash">Kontant</label>
                  </div>
                  <div class="form-check">
                    <input class="form-check-input" type="checkbox" name="paymentCard" value="Kort" id="check-payment-card">
                    <label class="form-check-label" for="check-payment-card">Kort</label>
                  </div>
                  <div class="form-check">
                    <input class="form-check-input" type="checkbox" name="paymentSms" value="SMS" id="check-payment-sms">
                    <label class="form-check-label" for="check-payment-sms">SMS</label>
                  </div>
                  <div class="form-check">
                    <input class="form-check-input" type="checkbox" name="paymentApp" value="App" id="check-payment-app">
                    <label class="form-check-label" for="check-payment-app">App</label>
                  </div>
                  <div class="form-check">
                    <input class="form-check-input" type="checkbox" name="paymentRfid" value="RFID" id="check-payment-rfid">
                    <label class="form-check-label" for="check-payment-rfid">RFID</label>
                  </div>
                </div>
              </div>

            </div>

            <div class="form-group row">
              <label class="col-md-4 col-form-label">Parkeringsavgift</label>
              <div class="col-md-2 pr-0">
                <select name="hasParkingFee" class="custom-select">
                  <option value="">Välj…</option>
                  <option value="true">Ja</option>
                  <option value="false">Nej</option>
                </select>
              </div>
              <div class="col-md-6 pl-1">
                <input type="text" name="parkingDescription" class="form-control" placeholder="T. ex. “30kr/tim”">
              </div>
            </div>

          </fieldset>


          <fieldset class="border rounded-lg" data-key="other">
            <legend>Övriga upplysningar</legend>

            <div class="form-group row">
              <label class="col-md-4 col-form-label">Realtidsinfo.</label>
              <div class="col-3 col-md-2 pr-0">
                <select name="hasRealTimeInfo" class="custom-select">
                  <option value="">Välj…</option>
                  <option value="true">Ja</option>
                  <option value="false">Nej</option>
                </select>
              </div>
              <div class="col-9 col-md-6 pl-1">
                <input type="text" name="realTimeInfoDescription" class="form-control" placeholder="T. ex. “via Vattenfall InCharge”">
              </div>
            </div>

            <div class="form-group row">
              <label for="input-subsidy" class="col-md-4 col-form-label">Utbyggnadsstöd</label>
              <div class="col-md-8">
                <input type="text" name="subsidy" class="form-control" id="input-subsidy" placeholder="T. ex. “Klimatklivet”">
              </div>
            </div>

            <div class="form-group row">
              <label for="textarea-other-general" class="col-md-4 col-form-label">Övrigt</label>
              <div class="col-md-8">
                <textarea name="general" class="form-control" id="textarea-other-general" rows="3"></textarea>
              </div>
            </div>

          </fieldset>

        </div>

        <div class="col-12 col-lg-6 json-result">
          <h4>JSON data</h4>
          <pre class="border rounded-lg"><code class="language-json"></code></pre>
        </div>

      </div>

    </div>

    <script type="text/javascript" charset="utf-8">

      const STORE_KEY = 'formJSON';
      const formContainerEl = document.querySelector('.form-container');
      let _changeTimeout;

      /**
       * recursiveGetObjectFromDOM
       */
      function recursiveGetObjectFromDOM(el) {
        // Inputs with name
        if (el.hasAttribute('name')) {
          return getReturnObject(el);
        }
        // Object or list key
        const objKey = el.getAttribute('data-key');
        const listKey = el.getAttribute('data-list-key');

        if (el.children.length) {
          // Children objs
          const childrenObjs = Array.from(el.children)
            .map(function(childEl) { return recursiveGetObjectFromDOM(childEl); })
            .filter(function(obj) { return !!obj; });
          // If single child object, return
          if (!(listKey || objKey) && childrenObjs.length === 1) {
            return childrenObjs[0];
          }
          // If el has data-list-key, return childrenObjs on this key
          if (listKey && childrenObjs.length) {
            return { [listKey]: childrenObjs };
          }
          // Only return if childrenObjs, else undefined
          if (childrenObjs.length) {
            // Merge to single obj
            const mergedChildrenObj = childrenObjs.reduce(function(acc, childObj) {
              return Object.assign(acc, childObj);
            }, {});
            // If el has data-key, return merged childrenObjs object on this key
            if (objKey) {
              return { [objKey]: mergedChildrenObj};
            }
            // Else return mergedChildrenObj
            return mergedChildrenObj;
          }
        }
      }
      /**
       * recursiveSetDOMFromObject
       */
      function recursiveSetDOMFromObject(el, obj = {}) {
        // Inputs with name
        const elName = el.getAttribute('name');
        if (elName) {
          // If obj is array and el is checkbox
          if (Array.isArray(obj) && el.getAttribute('type') === 'checkbox') {
            el.checked = obj.includes(el.value);
          }
          // Name present as key on obj
          else if (obj.hasOwnProperty(elName)) {
            el.value = obj[elName];
          }
        }
        // If el has data-key or data-list-key, pass the value of this key to children
        const dataKey = el.getAttribute('data-key');
        const dataListKey = el.getAttribute('data-list-key');
        const listItemSelector = el.getAttribute('data-list-item-selector');
        const listItemEl = el.querySelector(listItemSelector);
        // Pad children with list items
        if (dataListKey && listItemEl) {
          let clonedListItemNode;
          for (let i = 0, il = obj[dataListKey].length; i < il - 1; i++) {
            clonedListItemNode = listItemEl.cloneNode(true);
            listItemEl.parentElement.append(clonedListItemNode);
          }
        }
        if (el.children.length) {
          return Array.from(el.children)
            .forEach(function(childEl, i) {
              recursiveSetDOMFromObject(
                childEl,
                dataKey
                  ? obj[dataKey]
                  : (dataListKey
                    ? (obj[dataListKey] && listItemEl ? obj[dataListKey][i] : obj[dataListKey])
                    : obj
                  )
              );
            });
        }

      }
      /**
       * getReturnObject
       */
      function getReturnObject(el) {
        const key = el.getAttribute('name');
        let value = el.value.length ? typeCast(el.value) : undefined;
        // If no value
        if (typeof value === 'undefined') {
          return;
        }
        // If checkbox
        if (el.getAttribute('type') === 'checkbox') {
          return el.checked ? value : undefined;
        }
        return { [key]: value };
      }
      /**
       * typeCast
       */
      function typeCast(value) {
        if (!isNaN(Number(value))) {
          return Number(value);
        }
        if (value === 'true' || value === 'false') {
          return value === 'true';
        }
        return value;
      }
      /**
       * handleFormUpdate
       */
      function handleFormUpdate() {
        const data = recursiveGetObjectFromDOM(formContainerEl);
        console.log('data', data);
        const jsonStr = JSON.stringify(data, null, 2);
        // Set localStorage
        window.localStorage.setItem(STORE_KEY, jsonStr);
        // Populate JSON display and highlight code
        const jsonEl = document.querySelector('.language-json')
        jsonEl.innerHTML = jsonStr;
        window.Prism.highlightElement(jsonEl);
      }
      /**
       * onBeforeUnload
       */
      function onBeforeUnload(event) {
        const data = recursiveGetObjectFromDOM(formContainerEl);
        window.localStorage.setItem(STORE_KEY, JSON.stringify(data, null, 2));
      }

      // Init
      if (window.localStorage.hasOwnProperty(STORE_KEY)) {
        const jsonStr = window.localStorage.getItem(STORE_KEY);
        // Populate form
        if (jsonStr) {
          recursiveSetDOMFromObject(
            formContainerEl,
            JSON.parse(jsonStr)
          );
        }
        // Populate JSON display
        document.querySelector('.language-json').innerHTML = jsonStr;
      }
      /**
       * onFormChange
       */
      function onFormChange(event) {
        clearTimeout(_changeTimeout);
        _changeTimeout = setTimeout(function() {
          handleFormUpdate();
        }, 500);
      }
      /**
       * onAddRowClick
       */
      function onAddRowClick(event) {
        const parentEl = event.target.parentElement;
        const listEl = parentEl.querySelector('[data-list-key]');
        const listItemSelector = listEl.getAttribute('data-list-item-selector');
        const clonedListItemEl = listEl.querySelector(listItemSelector).cloneNode(true);
        clonedListItemEl
          .querySelectorAll('[name]')
          .forEach(function(el) {
            el.value = undefined;
          });
        listEl.append( clonedListItemEl.cloneNode(true) );
      }

      // Add change listeners
      formContainerEl.addEventListener('input', onFormChange);
      formContainerEl.addEventListener('change', onFormChange);
      // Add beforeunload listener
      window.addEventListener('beforeunload', onBeforeUnload);
      // On click btn handlers
      formContainerEl
        .querySelector('.btn-add-row')
        .addEventListener('click', onAddRowClick);

    </script>

    <script src="prism.js" type="text/javascript" charset="utf-8"></script>

  </body>

</html>
